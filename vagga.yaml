containers:
  build:
    setup:
    - !UbuntuRelease { version: 15.10 }
    - !UbuntuUniverse
    - !Install [ ca-certificates, make, cmake, clang, gcc, g++, libboost-all-dev, gdbserver,
                 ruby, libicu-dev, python-pip,
                 haskell-platform, rsync, texlive-latex-extra, texlive-fonts-recommended ]
    - !BuildDeps [ ruby-dev, zlib1g-dev ]
    - !Env
      HOME: /root # For cabal
    - !Sh |
        cabal update
        cabal install filemanip megaparsec shake text
        pip install sphinx sphinx-autobuild
        pip install sphinx_rtd_theme
        gem install copyright-header

    volumes:
      /tmp: !Tmpfs {size: 1Gi}

commands:
  add-copyright-headers: !Command
    description: Add copyright header to C++ files
    accepts-arguments: true
    container: build
    work-dir: /work
    run: copyright-header/add-header "$@"
  shake: &shake !Command
    description: Build and test everything
    accepts-arguments: true
    container: build
    work-dir: /work/haskell
    environ: { HOME: /root }
    run: ./Build.hs "$@"
  doc: !Command
    <<: *shake
    description: Build docs
    run: ./Build.hs docs
  quick: !Command
    <<: *shake
    description: Build with gcc only in debug mode
    run: ./Build.hs quick
  clean: !Command
    <<: *shake
    description: Clean the build
    run: ./Build.hs clean
